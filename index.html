<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twoje Pliki</title>
    <style>/* Ca≈Çy CSS pozostaje bez zmian - skopiuj go z poprzedniej wersji */ body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; } .hidden { display: none !important; } #login-screen { text-align: center; margin-top: 20vh; } .login-box input { font-size: 1.5em; padding: 10px; width: 150px; text-align: center; border: 1px solid #ccc; border-radius: 8px; margin: 20px 0; } .login-box button { font-size: 1em; padding: 10px 20px; cursor: pointer; border: none; background-color: #007bff; color: white; border-radius: 8px; } #error-message { color: red; } #app-container { max-width: 1200px; margin: 0 auto; } #upload-area { border: 3px dashed #ccc; border-radius: 15px; padding: 40px; margin-bottom: 30px; cursor: pointer; text-align: center; background-color: #fff; } #upload-area:hover, #upload-area.drag-over { background-color: #f8f9fa; border-color: #007bff; } #upload-icon { font-size: 50px; color: #ccc; } #file-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 20px; padding: 20px; background-color: #fff; border-radius: 8px; } .file-item { position: relative; display: flex; flex-direction: column; align-items: center; padding: 10px; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; } .file-item:hover { background-color: #e9ecef; } .file-icon { width: 70px; height: 70px; background-size: cover; background-position: center; background-repeat: no-repeat; margin-bottom: 10px; } .file-icon-img { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234B86F7"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M8,12H16V14H8V12M8,16H16V18H8V16Z" /></svg>'); } .file-icon-txt { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236c757d"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM18 20H6V4h7v5h5v11zM8 15h8v2H8v-2zm0-4h8v2H8v-2z" /></svg>'); } .file-name { font-size: 14px; text-align: center; word-break: break-all; } .file-actions { position: absolute; top: 5px; right: 5px; display: none; } .file-item:hover .file-actions { display: flex; } .action-btn { border: none; background: rgba(255, 255, 255, 0.8); border-radius: 50%; width: 24px; height: 24px; cursor: pointer; margin-left: 5px; font-size: 16px; }</style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box"><h1>Wprowad≈∫ kod dostƒôpu</h1><input type="password" id="access-code" placeholder="----" maxlength="4"><button id="login-button">Wejd≈∫</button><p id="error-message" class="hidden">Nieprawid≈Çowy kod.</p></div>
    </div>
    <div id="app-container" class="hidden">
        <div id="upload-area"><div id="upload-icon">+</div><p>Upu≈õƒá pliki tutaj lub kliknij, aby wybraƒá</p><input type="file" id="file-input" multiple hidden></div>
        <div id="file-list-container"></div>
    </div>

<script>
    // --- KONFIGURACJA ---
    const BACKEND_URL = "https://eosforus-box.hf.space";
    const REPO_ID_FOR_URL = "Eosforus/box";
    
    // ZMIANA: Usuwamy stƒÖd kod dostƒôpu!
    // const CORRECT_ACCESS_CODE = "";
    
    // ZMIANA: Zmienna do przechowywania naszego tokena sesji
    let sessionToken = null;

    // --- Elementy DOM (bez zmian) ---
    const loginScreen = document.getElementById('login-screen');
    const appContainer = document.getElementById('app-container');
    const accessCodeInput = document.getElementById('access-code');
    const loginButton = document.getElementById('login-button');
    const errorMessage = document.getElementById('error-message');
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('file-input');
    const fileListContainer = document.getElementById('file-list-container');

    // --- ZMIANA: Nowa logika logowania ---
    loginButton.addEventListener('click', async () => {
        errorMessage.classList.add('hidden');
        try {
            const response = await fetch(`${BACKEND_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code: accessCodeInput.value })
            });

            if (!response.ok) {
                throw new Error('Nieprawid≈Çowy kod');
            }
            
            const data = await response.json();
            sessionToken = data.access_token; // Zapisujemy token
            
            // Je≈õli logowanie siƒô powiod≈Ço
            loginScreen.classList.add('hidden');
            appContainer.classList.remove('hidden');
            loadFiles(); // ≈Åadujemy pliki dopiero po uzyskaniu tokena

        } catch (error) {
            errorMessage.classList.remove('hidden');
        }
    });

    // --- ZMIANA: Funkcja pomocnicza do tworzenia nag≈Ç√≥wk√≥w autoryzacji ---
    function getAuthHeaders() {
        if (!sessionToken) throw new Error("Brak tokena sesji");
        return {
            'Authorization': `Bearer ${sessionToken}`,
            'Content-Type': 'application/json'
        };
    }
    
    // --- ZAKTUALIZOWANE FUNKCJE API ---
    async function loadFiles() {
        fileListContainer.innerHTML = '<p>≈Åadowanie plik√≥w...</p>';
        try {
            const headers = getAuthHeaders();
            delete headers['Content-Type']; // GET nie potrzebuje Content-Type
            const response = await fetch(`${BACKEND_URL}/files`, { headers });
            const data = await response.json();
            
            fileListContainer.innerHTML = '';
            if (data.files.length === 0) {
                fileListContainer.innerHTML = '<p>Brak plik√≥w w magazynie.</p>';
            } else {
                data.files.forEach(addFileToGrid);
            }
        } catch (error) {
            fileListContainer.innerHTML = `<p>Nie uda≈Ço siƒô za≈Çadowaƒá plik√≥w. B≈ÇƒÖd: ${error.message}</p>`;
        }
    }

    async function handleFiles(files) {
        for (const file of files) {
            const formData = new FormData();
            formData.append('file', file);
            try {
                // Fetch dla FormData nie ustawia 'Content-Type', przeglƒÖdarka robi to sama
                const response = await fetch(`${BACKEND_URL}/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${sessionToken}` },
                    body: formData
                });
                if (!response.ok) throw new Error('B≈ÇƒÖd serwera');
                const result = await response.json();
                addFileToGrid(result.filename);
            } catch (error) {
                alert(`Nie uda≈Ço siƒô przes≈Çaƒá pliku: ${file.name}. B≈ÇƒÖd: ${error.message}`);
            }
        }
    }
    
    fileListContainer.addEventListener('click', async (e) => {
        const target = e.target;
        const fileItem = target.closest('.file-item');
        if (!fileItem) return;
        
        const filename = fileItem.dataset.filename;

        if (target.matches('.delete-btn')) {
            if (!confirm(`Czy na pewno chcesz usunƒÖƒá plik "${filename}"?`)) return;
            try {
                const response = await fetch(`${BACKEND_URL}/delete`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ filename })
                });
                if (!response.ok) throw new Error('B≈ÇƒÖd serwera');
                fileItem.remove();
            } catch (error) {
                alert(`Nie uda≈Ço siƒô usunƒÖƒá pliku. ${error.message}`);
            }
        }
        
        if (target.matches('.rename-btn')) {
            const newFilename = prompt("Wprowad≈∫ nowƒÖ nazwƒô dla pliku:", filename);
            if (newFilename && newFilename !== filename) {
                try {
                    const response = await fetch(`${BACKEND_URL}/rename`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({ old_filename: filename, new_filename: newFilename })
                    });
                    if (!response.ok) throw new Error('B≈ÇƒÖd serwera');
                    // Aktualizuj widok
                    fileItem.dataset.filename = newFilename;
                    fileItem.querySelector('.file-name').textContent = newFilename;
                } catch (error) {
                    alert(`Nie uda≈Ço siƒô zmieniƒá nazwy. ${error.message}`);
                }
            }
        }
    });

    // Funkcja addFileToGrid pozostaje bez zmian
    function addFileToGrid(fileName) {
        const placeholder = fileListContainer.querySelector('p');
        if (placeholder) placeholder.remove();
        const fileUrl = `https://huggingface.co/datasets/${REPO_ID_FOR_URL}/resolve/main/${encodeURIComponent(fileName)}`;
        const fileExt = fileName.split('.').pop().toLowerCase();
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.dataset.filename = fileName;
        const icon = document.createElement('div');
        icon.className = 'file-icon';
        if (['png', 'jpg', 'jpeg', 'gif', 'webp'].includes(fileExt)) {
            icon.style.backgroundImage = `url(${fileUrl}?token=${sessionToken})`; // Dodajemy token do URL obrazka
        } else if (['txt', 'md', 'json', 'csv'].includes(fileExt)) {
            icon.classList.add('file-icon-txt');
        } else {
            icon.classList.add('file-icon-img');
        }
        const name = document.createElement('span');
        name.className = 'file-name';
        name.textContent = fileName;
        const actions = document.createElement('div');
        actions.className = 'file-actions';
        actions.innerHTML = `<button class="action-btn rename-btn" title="Zmie≈Ñ nazwƒô">‚úèÔ∏è</button><button class="action-btn delete-btn" title="Usu≈Ñ">üóëÔ∏è</button>`;
        fileItem.append(icon, name, actions);
        fileItem.addEventListener('click', (e) => {
            if (!e.target.classList.contains('action-btn')) {
                window.open(fileUrl, '_blank');
            }
        });
        fileListContainer.prepend(fileItem);
    }
</script>
</body>
</html>
