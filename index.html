<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twoje Pliki</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#f0f2f5;margin:0;padding:20px;-webkit-user-select:none;user-select:none;}.hidden{display:none!important}#login-screen{text-align:center;margin-top:20vh}.login-box input{font-size:1.5em;padding:10px;width:150px;text-align:center;border:1px solid #ccc;border-radius:8px;margin:20px 0}.login-box button{font-size:1em;padding:10px 20px;cursor:pointer;border:none;background-color:#007bff;color:#fff;border-radius:8px}#error-message{color:red}#app-container{max-width:1200px;margin:0 auto}#upload-area{border:3px dashed #ccc;border-radius:15px;padding:40px;margin-bottom:30px;cursor:pointer;text-align:center;background-color:#fff}#upload-area:hover,#upload-area.drag-over{background-color:#f8f9fa;border-color:#007bff}#upload-icon{font-size:50px;color:#ccc}#file-list-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:20px;padding:20px;background-color:#fff;border-radius:8px;min-height:200px;}.file-item{position:relative;display:flex;flex-direction:column;align-items:center;padding:10px;border-radius:8px;cursor:pointer;transition:background-color .2s;-webkit-user-drag:element;}.file-item:hover{background-color:#e9ecef}.file-icon{width:70px;height:70px;background-size:cover;background-position:center;background-repeat:no-repeat;margin-bottom:10px;pointer-events:none;background-color:#e9ecef;}.file-icon-img{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236c757d"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM18 20H6V4h7v5h5v11z"/></svg>')}.file-icon-txt{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234A90E2"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM18 20H6V4h7v5h5v11zM8 15h8v2H8v-2zm0-4h8v2H8v-2z"/></svg>')}.file-icon-pdf{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23D0021B"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM9.5 14.5v-2H11v.5h2v-1h-2v-.5h-1.5v-2h3c.8 0 1.5.7 1.5 1.5v1c0 .8-.7 1.5-1.5 1.5h-3zm6.5 0h-1.5v-5H16v5zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6z"/></svg>')}.file-icon-folder{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFC107"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>')}.file-name{font-size:14px;text-align:center;word-break:break-all;pointer-events:none;}.file-actions{position:absolute;top:5px;right:5px;display:none;background-color:rgba(240,242,245,0.7);border-radius:10px;padding:2px;}.file-item:hover .file-actions{display:flex}.action-btn{border:none;background:0 0;border-radius:50%;width:24px;height:24px;cursor:pointer;margin-left:5px;font-size:16px;line-height:24px;}
        @media (hover: none) and (pointer: coarse), (max-width: 768px) { .file-actions { display: flex; position: static; margin-top: 10px; background-color: transparent; } .file-item:hover .file-actions { display: flex; } .file-item { padding-bottom: 5px; } }
        #modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center}
        #modal-viewer{background-color:#fff;width:90%;max-width:90vw;height:90%;max-height:90vh;border-radius:8px;display:flex;flex-direction:column}
        #modal-header{padding:10px 15px;border-bottom:1px solid #ccc;display:flex;justify-content:space-between;align-items:center}
        #modal-filename{font-weight:700}
        #modal-close-btn{font-size:24px;cursor:pointer;border:none;background:0 0}
        #modal-content{padding:15px;overflow:auto;flex-grow:1;display:flex;align-items:center;justify-content:center}
        #modal-content pre{margin:0;white-space:pre-wrap;word-wrap:break-word;width:100%}
        #modal-content img{display:none;max-width:100%;max-height:100%;object-fit:contain}
        #context-menu{position:fixed;z-index:10000;width:180px;background-color:#fff;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,.2);padding:5px 0}.context-menu-item{padding:8px 15px;cursor:pointer}.context-menu-item:hover{background-color:#f0f2f5}
    </style>
</head>
<body>
    <div id="login-screen"><!-- HTML bez zmian --></div>
    <div id="app-container" class="hidden"><!-- HTML bez zmian --></div>
    <div id="modal-overlay" class="hidden">
        <div id="modal-viewer">
            <div id="modal-header"><span id="modal-filename"></span><button id="modal-close-btn" title="Zamknij">&times;</button></div>
            <div id="modal-content">
                <pre><code></code></pre>
                <img id="modal-image" alt="Podgląd obrazu">
            </div>
        </div>
    </div>
    <div id="context-menu" class="hidden"><!-- HTML bez zmian --></div>

<script>
    // --- Konfiguracja i Zmienne Globalne ---
    const BACKEND_URL = "https://eosforus-box.hf.space";
    const PUBLIC_DATASET_URL = "https://huggingface.co/datasets/Eosforus/box/resolve/main/";
    const TEXT_FILE_EXTENSIONS = ['txt', 'md', 'json', 'js', 'py', 'css', 'html', 'log'];
    const IMAGE_FILE_EXTENSIONS = ['png', 'jpg', 'jpeg', 'gif', 'webp'];
    let sessionToken = null;

    // --- Pobranie Elementów DOM ---
    const dom = { /* ... bez zmian ... */ };
    Object.assign(dom, {
        loginScreen: document.getElementById('login-screen'), appContainer: document.getElementById('app-container'),
        accessCodeInput: document.getElementById('access-code'), loginButton: document.getElementById('login-button'),
        errorMessage: document.getElementById('error-message'), uploadArea: document.getElementById('upload-area'),
        fileInput: document.getElementById('file-input'), fileListContainer: document.getElementById('file-list-container'),
        modalOverlay: document.getElementById('modal-overlay'), modalFilename: document.getElementById('modal-filename'),
        modalContent: document.querySelector('#modal-content pre code'), modalImage: document.getElementById('modal-image'),
        modalCloseBtn: document.getElementById('modal-close-btn'), contextMenu: document.getElementById('context-menu'),
        newFolderBtn: document.getElementById('new-folder-btn')
    });
    
    // --- Funkcje Pomocnicze ---
    function getAuthHeaders() { /* ... bez zmian ... */ }
    async function forceDownload(url, filename) { /* ... bez zmian ... */ }
    async function loadAndSetImagePreview(iconElement, imageUrl) { /* ... bez zmian ... */ }

    async function showModal(filename, type) {
        dom.modalFilename.textContent = filename;
        dom.modalOverlay.classList.remove('hidden');
        
        const fileUrl = `${BACKEND_URL}/download/${encodeURIComponent(filename)}`;
        
        if (type === 'image') {
            dom.modalImage.style.display = 'block';
            dom.modalContent.style.display = 'none';
            dom.modalImage.src = ''; // Wyczyść stary obrazek
            try {
                const response = await fetch(fileUrl, { headers: getAuthHeaders() });
                if (!response.ok) throw new Error('Nie udało się załadować obrazu');
                const blob = await response.blob();
                const blobUrl = URL.createObjectURL(blob);
                dom.modalImage.src = blobUrl;
            } catch (error) {
                alert(error.message);
            }
        } else { // type === 'text'
            dom.modalImage.style.display = 'none';
            dom.modalContent.style.display = 'block';
            dom.modalContent.textContent = 'Ładowanie...';
            try {
                const response = await fetch(fileUrl, { headers: getAuthHeaders() });
                if (!response.ok) throw new Error('Nie udało się pobrać zawartości');
                const textContent = await response.text();
                dom.modalContent.textContent = textContent;
            } catch (error) {
                dom.modalContent.textContent = `Błąd: ${error.message}`;
            }
        }
    }
    
    // --- Główna Logika Aplikacji ---
    function addItemToGrid({ name, type }) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.dataset.filename = name;
        fileItem.dataset.type = type;

        const icon = document.createElement('div');
        icon.className = 'file-icon';
        
        if (type === 'folder') {
            icon.classList.add('file-icon-folder');
        } else {
            const fileExt = name.split('.').pop().toLowerCase();
            fileItem.setAttribute('draggable', 'true');
            if (IMAGE_FILE_EXTENSIONS.includes(fileExt)) {
                loadAndSetImagePreview(icon, `${BACKEND_URL}/download/${encodeURIComponent(name)}`);
            } else if (fileExt === 'pdf') {
                icon.classList.add('file-icon-pdf');
            } else if (TEXT_FILE_EXTENSIONS.includes(fileExt)) {
                icon.classList.add('file-icon-txt');
            } else {
                icon.classList.add('file-icon-img');
            }
        }

        const nameEl = document.createElement('span');
        nameEl.className = 'file-name';
        nameEl.textContent = name;
        
        fileItem.append(icon, nameEl);
        
        if (type === 'file') {
            const actions = document.createElement('div');
            actions.className = 'file-actions';
            actions.innerHTML = `<button class="action-btn download-btn" title="Pobierz">⬇️</button><button class="action-btn rename-btn" title="Zmień nazwę">✏️</button><button class="action-btn delete-btn" title="Usuń">🗑️</button>`;
            fileItem.appendChild(actions);
        }
        dom.fileListContainer.appendChild(fileItem);
    }
    
    async function loadFiles() { /* ... bez zmian ... */ }
    async function handleFiles(files) { /* ... bez zmian ... */ }

    async function createNewFolder() {
        const folderName = prompt("Wprowadź nazwę nowego folderu:");
        if (folderName && folderName.trim()) {
            try {
                const response = await fetch(`${BACKEND_URL}/create-folder`, { method: 'POST', headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ folder_name: folderName.trim() }) });
                if (!response.ok) throw new Error('Nie udało się utworzyć folderu.');
                // NAPRAWIONO: Natychmiastowe dodanie do widoku
                addItemToGrid({ name: folderName.trim(), type: 'folder' });
            } catch (error) {
                alert(error.message);
            }
        }
    }

    // --- "Nasłuchiwacze Zdarzeń" ---
    
    dom.loginButton.addEventListener('click', async () => { /* ... bez zmian ... */ });
    dom.accessCodeInput.addEventListener('keyup', e => { /* ... bez zmian ... */ });
    dom.uploadArea.addEventListener('click', () => dom.fileInput.click());
    dom.fileInput.addEventListener('change', e => handleFiles(e.target.files));
    dom.uploadArea.addEventListener('dragover', e => { /* ... bez zmian ... */ });
    dom.uploadArea.addEventListener('dragleave', e => { /* ... bez zmian ... */ });
    dom.uploadArea.addEventListener('drop', e => { /* ... bez zmian ... */ });

    dom.modalCloseBtn.addEventListener('click', () => {
        dom.modalOverlay.classList.add('hidden');
        // Zatrzymujemy ładowanie i czyścimy src, aby zwolnić pamięć
        dom.modalImage.src = ''; 
    });
    dom.modalOverlay.addEventListener('click', (e) => { if (e.target === dom.modalOverlay) dom.modalCloseBtn.click(); });

    dom.newFolderBtn.addEventListener('click', createNewFolder);
    dom.appContainer.addEventListener('contextmenu', e => { /* ... bez zmian ... */ });
    let longPressTimer;
    dom.appContainer.addEventListener('touchstart', e => { /* ... bez zmian ... */ });
    dom.appContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
    dom.appContainer.addEventListener('touchmove', () => clearTimeout(longPressTimer));
    document.addEventListener('click', () => dom.contextMenu.classList.add('hidden'));

    dom.fileListContainer.addEventListener('dragstart', (e) => { /* ... bez zmian ... */ });
    
    dom.fileListContainer.addEventListener('click', async (e) => {
        const target = e.target;
        const fileItem = target.closest('.file-item');
        if (!fileItem) return;

        const filename = fileItem.dataset.filename;
        const type = fileItem.dataset.type;

        if (type === 'folder') { return; } // Na razie nic nie robimy z folderami

        const fileExt = filename.split('.').pop().toLowerCase();
        const fileUrl = `${BACKEND_URL}/download/${encodeURIComponent(filename)}`;

        if (target.matches('.download-btn')) {
            forceDownload(fileUrl, filename);
            return;
        }

        if (!target.closest('.file-actions')) {
            if (IMAGE_FILE_EXTENSIONS.includes(fileExt)) {
                showModal(filename, 'image'); // Pokaż podgląd obrazu
            } else if (TEXT_FILE_EXTENSIONS.includes(fileExt)) {
                showModal(filename, 'text'); // Pokaż podgląd tekstu
            } else {
                forceDownload(fileUrl, filename); // Pobierz inne pliki (np. PDF)
            }
            return;
        }
        
        if (target.matches('.delete-btn')) { /* ... bez zmian ... */ }
        if (target.matches('.rename-btn')) { /* ... bez zmian ... */ }
    });

    // Uzupełnienie reszty funkcji dla kompletności
    function getAuthHeaders(){if(!sessionToken)throw new Error("Brak tokena sesji");return{'Authorization':`Bearer ${sessionToken}`}}
    async function forceDownload(e,t){try{const n=await fetch(e,{headers:getAuthHeaders()});if(!n.ok)throw new Error(`Błąd serwera: ${n.statusText}`);const o=await n.blob(),a=window.URL.createObjectURL(o),d=document.createElement("a");d.style.display="none",d.href=a,d.download=t,document.body.appendChild(d),d.click(),window.URL.revokeObjectURL(a),d.remove()}catch(e){console.error("Błąd pobierania:",e),alert("Nie udało się pobrać pliku.")}}
    async function loadAndSetImagePreview(e,t){try{const n=await fetch(t,{headers:getAuthHeaders()});if(!n.ok)throw new Error("Nie udało się załadować podglądu");const o=await n.blob(),a=URL.createObjectURL(o);e.style.backgroundImage=`url(${a}`)}catch(e){console.error("Błąd ładowania podglądu:",e)}}
    async function loadFiles(){dom.fileListContainer.innerHTML="<p>Ładowanie...</p>";try{const e=await fetch(`${BACKEND_URL}/files`,{headers:getAuthHeaders()});if(!e.ok)throw new Error("Błąd autoryzacji lub serwera");const t=await e.json();dom.fileListContainer.innerHTML="";const n=new Set,o=[];t.files&&t.files.length&&(t.files.forEach(e=>{e.includes("/")?n.add(e.split("/")[0]):o.push(e)}),[...n].sort().forEach(e=>addItemToGrid({name:e,type:"folder"})),o.sort().forEach(e=>addItemToGrid({name:e,type:"file"})))}catch(e){dom.fileListContainer.innerHTML=`<p>Nie udało się załadować plików. ${e.message}</p>`}}
    async function handleFiles(e){for(const t of e){const n=new FormData;n.append("file",t);try{const e=await fetch(`${BACKEND_URL}/upload`,{method:"POST",headers:{'Authorization':`Bearer ${sessionToken}`},body:n});if(!e.ok)throw new Error("Błąd serwera");const o=await e.json();addItemToGrid({name:o.filename,type:"file"})}catch(e){alert(`Nie udało się przesłać pliku: ${t.name}.`)}}}
    dom.loginButton.addEventListener("click",async()=>{dom.errorMessage.classList.add("hidden");try{const e=await fetch(`${BACKEND_URL}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:dom.accessCodeInput.value})});if(!e.ok)throw new Error("Nieprawidłowy kod");const t=await e.json();sessionToken=t.access_token,dom.loginScreen.classList.add("hidden"),dom.appContainer.classList.remove("hidden"),loadFiles()}catch(e){dom.errorMessage.classList.remove("hidden")}});
    dom.accessCodeInput.addEventListener("keyup",e=>{if("Enter"===e.key)dom.loginButton.click()});
    dom.uploadArea.addEventListener("click",()=>dom.fileInput.click()),dom.fileInput.addEventListener("change",e=>handleFiles(e.target.files)),dom.uploadArea.addEventListener("dragover",e=>{e.preventDefault(),e.currentTarget.classList.add("drag-over")}),dom.uploadArea.addEventListener("dragleave",e=>{e.preventDefault(),e.currentTarget.classList.remove("drag-over")}),dom.uploadArea.addEventListener("drop",e=>{e.preventDefault(),e.currentTarget.classList.remove("drag-over"),handleFiles(e.dataTransfer.files)});
    dom.newFolderBtn.addEventListener("click",createNewFolder),dom.appContainer.addEventListener("contextmenu",e=>{e.preventDefault(),dom.contextMenu.style.top=`${e.clientY}px`,dom.contextMenu.style.left=`${e.clientX}px`,dom.contextMenu.classList.remove("hidden")});
    dom.appContainer.addEventListener("touchstart",e=>{longPressTimer=setTimeout(()=>{e.preventDefault();const t=e.touches[0];dom.contextMenu.style.top=`${t.clientY}px`,dom.contextMenu.style.left=`${t.clientX}px`,dom.contextMenu.classList.remove("hidden")},500)}),dom.appContainer.addEventListener("touchend",()=>clearTimeout(longPressTimer)),dom.appContainer.addEventListener("touchmove",()=>clearTimeout(longPressTimer)),document.addEventListener("click",()=>dom.contextMenu.classList.add("hidden"));
    dom.fileListContainer.addEventListener("dragstart",e=>{const t=e.target.closest(".file-item");if(t&&"file"===t.dataset.type){const n=t.dataset.filename,o=`${PUBLIC_DATASET_URL}${encodeURIComponent(n)}`;e.dataTransfer.setData("DownloadURL",`application/octet-stream:${n}:${o}`)}});
    dom.fileListContainer.addEventListener('click', async (e) => { const target = e.target; const fileItem = target.closest('.file-item'); if (!fileItem) return; const filename = fileItem.dataset.filename; const type = fileItem.dataset.type; if (type === 'folder') return; const fileExt = filename.split('.').pop().toLowerCase(); const fileUrl = `${BACKEND_URL}/download/${encodeURIComponent(filename)}`; if (target.matches('.download-btn')) { forceDownload(fileUrl, filename); return; } if (!target.closest('.file-actions')) { if (IMAGE_FILE_EXTENSIONS.includes(fileExt)) { showModal(filename, 'image'); } else if (TEXT_FILE_EXTENSIONS.includes(fileExt)) { showModal(filename, 'text'); } else { forceDownload(fileUrl, filename); } return; } if (target.matches('.delete-btn')) { if (!confirm(`Czy na pewno chcesz usunąć plik "${filename}"?`)) return; try { const response = await fetch(`${BACKEND_URL}/delete`, { method: 'POST', headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ filename }) }); if (!response.ok) throw new Error('Błąd serwera'); fileItem.remove(); } catch (error) { alert(`Nie udało się usunąć pliku.`); } } if (target.matches('.rename-btn')) { const newFilename = prompt("Wprowadź nową nazwę dla pliku:", filename); if (newFilename && newFilename !== filename) { try { const response = await fetch(`${BACKEND_URL}/rename`, { method: 'POST', headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' }, body: JSON.stringify({ old_filename: filename, new_filename: newFilename }) }); if (!response.ok) throw new Error("Błąd serwera"); fileItem.dataset.filename = newFilename; fileItem.querySelector('.file-name').textContent = newFilename; const icon = fileItem.querySelector('.file-icon'); loadAndSetImagePreview(icon, `${BACKEND_URL}/download/${encodeURIComponent(newFilename)}`); } catch (error) { alert("Nie udało się zmienić nazwy."); } } } });
</script>
</body>
</html>
