<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Box</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#f0f2f5;margin:0;padding:20px;-webkit-user-select:none;user-select:none;}.hidden{display:none!important}#login-screen{text-align:center;margin-top:20vh}.login-box input{font-size:1.5em;padding:10px;width:150px;text-align:center;border:1px solid #ccc;border-radius:8px;margin:20px 0}.login-box button{font-size:1em;padding:10px 20px;cursor:pointer;border:none;background-color:#007bff;color:#fff;border-radius:8px}#error-message{color:red}#app-container{max-width:1200px;margin:0 auto}#upload-area{border:3px dashed #ccc;border-radius:15px;padding:40px;margin-bottom:30px;text-align:center;background-color:#fff}#upload-area p { pointer-events: none; } #upload-options{margin-top:15px;}.upload-button{display:inline-block;padding:8px 16px;font-size:0.9em;cursor:pointer;background-color:#007bff;color:#fff;border:none;border-radius:5px;margin:0 10px;}#upload-area:hover,#upload-area.drag-over{background-color:#f8f9fa;border-color:#007bff}#upload-icon{font-size:50px;color:#ccc; pointer-events: none;}
        #status-message{font-weight:bold;color:#0056b3;margin-top:10px;height:1.2em;}
        #progress-bar-container{width:100%;background-color:#e9ecef;border-radius:5px;margin-top:15px;height:10px;overflow:hidden;}
        #progress-bar{width:0%;height:100%;background-color:#007bff;border-radius:5px;transition:width .2s ease-in-out;}
        #status-container { display: flex; align-items: center; justify-content: center; gap: 10px; }
        #cancel-upload-btn { border: none; background: transparent; font-size: 1.5em; color: #dc3545; cursor: pointer; line-height: 1; padding: 0 5px; }
        #cancel-upload-btn:hover { color: #a71d2a; }
        #file-list-container{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:20px;padding:20px;background-color:#fff;border-radius:8px;min-height:200px;}.file-item{position:relative;display:flex;flex-direction:column;align-items:center;padding:10px;border-radius:8px;cursor:pointer;transition:background-color .2s;-webkit-user-drag:element;}.file-item:hover{background-color:#e9ecef}
        .file-item.drag-over-folder { background-color: #d0e7ff; box-shadow: 0 0 0 2px #007bff inset; }
        .file-icon{width:70px;height:70px;background-size:cover;background-position:center;background-repeat:no-repeat;margin-bottom:10px;pointer-events:none;background-color:#e9ecef;}.file-icon-img{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236c757d"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM18 20H6V4h7v5h5v11z"/></svg>')}.file-icon-txt{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234A90E2"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM18 20H6V4h7v5h5v11zM8 15h8v2H8v-2zm0-4h8v2H8v-2z"/></svg>')}
        
        /* IKONY PLIK√ìW */
        .file-icon-pdf{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23D32F2F"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1.5zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5v1.5H19v2h-1.5V7h2V8.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg>')}
        .file-icon-folder{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23FFC107"><path d="M10 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>')}.file-icon-zip{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%236c757d"><path d="M20 6h-4V4c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM10 4h4v2h-4V4zm10 16H4V8h2v2h2V8h8v2h2V8h2v12zM12 10h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>')}
        .file-icon-video{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234A148C"><path d="M10 16.5v-9l6 4.5-6 4.5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>')}
        .file-icon-audio{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23E65100"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7zM10.5 19c-1.38 0-2.5-1.12-2.5-2.5S9.12 14 10.5 14s2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>')}
        .file-icon-odt{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%231E88E5"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM14 9V3.5L19.5 9H14zM8 12h8v2H8v-2zm0 4h8v2H8v-2z"/></svg>')}

        .file-name{font-size:14px;text-align:center;word-break:break-all;pointer-events:none;}.file-actions{position:absolute;top:5px;right:5px;display:none;background-color:rgba(240,242,245,0.95);border-radius:10px;padding:4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);}.file-item:hover .file-actions{display:flex}.action-btn{border:none;background:0 0;border-radius:50%;width:28px;height:28px;cursor:pointer;margin-left:2px;font-size:18px;line-height:28px;transition: background-color 0.2s;} .action-btn:hover { background-color: #e2e6ea; }
        @media (hover: none) and (pointer: coarse), (max-width: 768px) { .file-actions { display: flex; position: static; margin-top: 10px; background-color: transparent; box-shadow: none; } .file-item:hover .file-actions { display: flex; } .file-item { padding-bottom: 5px; } }
        #modal-overlay, #share-modal-overlay, #editor-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);z-index:1000;display:flex;align-items:center;justify-content:center}
        #modal-viewer, #share-modal{background-color:#fff;width:90%;max-width:90vw;border-radius:8px;display:flex;flex-direction:column}
        #modal-viewer {height:90%;max-height:90vh;}
        #share-modal {max-width: 500px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);}
        #modal-header, #share-modal-header, #editor-modal-header{padding:10px 15px;border-bottom:1px solid #ccc;display:flex;justify-content:space-between;align-items:center}
        #share-modal-header { padding: 0 0 15px 0; }
        #modal-filename, #share-modal-title, #editor-filename{font-weight:700; font-size: 1.2em;}
        #modal-close-btn, #share-modal-close-btn{font-size:24px;cursor:pointer;border:none;background:0 0}
        #modal-content{padding:0;overflow:hidden;flex-grow:1;display:flex;background-color:#000}
        #modal-player-container {flex-grow: 1; display: flex; align-items: center; justify-content: center; padding: 15px; overflow: hidden; position: relative;}
        
        #modal-html-viewer { display:none; width:100%; height:100%; overflow:auto; background-color:#fff; padding:40px; color:#000; box-sizing: border-box; line-height: 1.6; text-align: left; }
        #modal-html-viewer h1, #modal-html-viewer h2, #modal-html-viewer h3 { margin-top: 1em; margin-bottom: 0.5em; }
        #modal-html-viewer p { margin-bottom: 1em; }
        #modal-html-viewer img { max-width: 100%; display: block; margin: 10px 0; }

        #modal-playlist-container {width: 280px; background-color: #f8f9fa; color: #000; overflow-y: auto; border-left: 1px solid #ccc;}
        .playlist-item {display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #e9ecef; font-size: 14px;}
        .playlist-item-name {white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px;}
        .playlist-item:hover {background-color: #e9ecef;}
        .playlist-item.active {background-color: #007bff; color: #fff; font-weight: bold;}
        .playlist-remove-btn {background:0 0; border:none; color: #aaa; font-size:1.2em; cursor:pointer; padding: 0 5px;}
        .playlist-remove-btn:hover {color: #dc3545;}
        .playlist-item.active .playlist-remove-btn {color: #fff;}
        #modal-content pre{display:none;margin:0;white-space:pre-wrap;word-wrap:break-word;width:100%;height:100%;overflow:auto;background-color:#fff;padding:15px;color:#000; text-align: left;}
        #modal-content img.preview-img{display:none;max-width:100%;max-height:100%;object-fit:contain}
        #modal-content iframe{display:none;width:100%;height:100%;border:none;}
        #modal-content video{display:none;max-width:100%;max-height:100%;outline:none}
        #modal-content audio{display:none;width:100%;}
        #context-menu{position:fixed;z-index:10000;width:180px;background-color:#fff;border-radius:8px;box-shadow:0 5px 15px rgba(0,0,0,.2);padding:5px 0}.context-menu-item{padding:8px 15px;cursor:pointer}.context-menu-item:hover{background-color:#f0f2f5}
        #path-bar{margin-bottom:10px;padding:8px;background-color:#e9ecef;border-radius:8px;font-weight:500;color:#495057;}.path-segment{cursor:pointer;}.path-segment:hover{text-decoration:underline;}
        
        .share-form-group { margin-bottom: 15px; }
        .share-form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .share-controls { display: flex; gap: 10px; }
        .share-controls input[type="number"] { width: 70px; padding: 8px; border: 1px solid #ccc; border-radius: 5px; }
        .share-controls select { padding: 8px; border: 1px solid #ccc; border-radius: 5px; flex-grow: 1; }
        #generate-share-link-btn { width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; margin-top: 10px;}
        #generate-share-link-btn:hover { background-color: #218838; }
        .share-result-section { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .copy-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .copy-group input, .copy-group textarea { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 0.9em; background-color: #f9f9f9; }
        .copy-group textarea { height: 60px; resize: none; }
        .copy-btn { padding: 0 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;}
        .copy-btn:hover { background-color: #0056b3; }

        #editor-modal { background-color: #fff; width: 90%; max-width: 1000px; height: 80%; border-radius: 8px; display: flex; flex-direction: column; }
        #editor-content-area { flex-grow: 1; padding: 10px; display: flex; flex-direction: column; }
        #file-editor-textarea { flex-grow: 1; width: 100%; resize: none; padding: 10px; border: 1px solid #ccc; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5; box-sizing: border-box; }
        #editor-footer { padding: 10px 15px; border-top: 1px solid #ccc; display: flex; justify-content: flex-end; gap: 10px; }
        .editor-btn { padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9em; border: none; }
        .editor-btn-cancel { background-color: #6c757d; color: white; }
        .editor-btn-save { background-color: #28a745; color: white; }
        .editor-btn:hover { opacity: 0.9; }

        /* STYLE DLA PRZYCISK√ìW KONWERSJI */
        .convert-btn {
            background-color: #f8f9fa;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px 10px;
            margin-left: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s;
        }
        .convert-btn:hover {
            background-color: #e2e6ea;
            border-color: #adb5bd;
        }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box"><h1>Wprowad≈∫ kod dostƒôpu</h1><input type="password" id="access-code" placeholder="----" maxlength="4"><button id="login-button">Wejd≈∫</button><p id="error-message" class="hidden">Nieprawid≈Çowy kod.</p></div>
    </div>
    <div id="app-container" class="hidden">
        <div id="path-bar"></div>
        <div id="upload-area">
            <div id="upload-icon">+</div>
            <p>Upu≈õƒá pliki tutaj lub wybierz opcjƒô</p>
            <div id="upload-options">
                <button id="upload-file-btn" class="upload-button">Prze≈õlij pliki</button>
                <button id="upload-folder-btn" class="upload-button">Prze≈õlij folder</button>
            </div>
            <div id="status-container" class="hidden">
                <span id="status-message"></span>
                <button id="cancel-upload-btn" title="Anuluj przesy≈Çanie">&times;</button>
            </div>
            <div id="progress-bar-container" class="hidden">
                <div id="progress-bar"></div>
            </div>
            <input type="file" id="file-input" multiple hidden>
            <input type="file" id="folder-input" webkitdirectory hidden>
        </div>
        <div id="file-list-container"></div>
    </div>
    
    <!-- G≈Å√ìWNY MODAL PODGLƒÑDU -->
    <div id="modal-overlay" class="hidden">
        <div id="modal-viewer">
            <div id="modal-header">
                <span id="modal-filename"></span>
                
                <!-- NOWE PRZYCISKI KONWERSJI (domy≈õlnie ukryte) -->
                <div id="modal-convert-actions" class="hidden" style="margin-left: auto; margin-right: 15px; display: flex; align-items: center;">
                    <span style="font-size: 0.8em; margin-right: 5px; color: #666;">Pobierz jako:</span>
                    <button class="convert-btn" onclick="downloadAs('plain')">TXT</button>
                    <button class="convert-btn" onclick="downloadAs('markdown')">MD</button>
                    <button class="convert-btn" onclick="downloadAs('html')">HTML</button>
                </div>

                <button id="modal-close-btn" title="Zamknij">&times;</button>
            </div>
            <div id="modal-content">
                <div id="modal-player-container">
                    <pre><code></code></pre>
                    <div id="modal-html-viewer"></div>
                    <img id="modal-image" class="preview-img" alt="PodglƒÖd obrazu">
                    <iframe id="modal-pdf-viewer"></iframe>
                    <video id="modal-video-viewer" controls></video>
                    <audio id="modal-audio-viewer" controls></audio>
                </div>
                <div id="modal-playlist-container" class="hidden"></div>
            </div>
        </div>
    </div>
    
    <!-- MODAL UDOSTƒòPNIANIA -->
    <div id="share-modal-overlay" class="hidden">
        <div id="share-modal">
            <div id="share-modal-header">
                <span id="share-modal-title">Udostƒôpnij plik</span>
                <button id="share-modal-close-btn">&times;</button>
            </div>
            <div id="share-settings">
                <div class="share-form-group">
                    <label>Czas wygasania linku:</label>
                    <div class="share-controls">
                        <input type="number" id="share-expires-value" value="1" min="1">
                        <select id="share-expires-unit">
                            <option value="minutes">Minuty</option>
                            <option value="hours">Godziny</option>
                            <option value="days" selected>Dni</option>
                            <option value="years">Lata</option>
                            <option value="never">Nigdy (Bez limitu)</option>
                        </select>
                    </div>
                </div>
                <button id="generate-share-link-btn">Generuj Link</button>
            </div>
            
            <div id="share-results" class="share-result-section hidden">
                <div class="share-form-group">
                    <label>Link bezpo≈õredni:</label>
                    <div class="copy-group">
                        <input type="text" id="share-result-link" readonly>
                        <button class="copy-btn" onclick="copyToClipboard('share-result-link')">Kopiuj</button>
                    </div>
                </div>
                <div class="share-form-group">
                    <label>Kod do osadzenia (Embed):</label>
                    <div class="copy-group">
                        <textarea id="share-result-embed" readonly></textarea>
                        <button class="copy-btn" onclick="copyToClipboard('share-result-embed')">Kopiuj</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDYTORA -->
    <div id="editor-modal-overlay" class="hidden">
        <div id="editor-modal">
            <div id="editor-modal-header">
                <span id="editor-filename">Edycja pliku</span>
            </div>
            <div id="editor-content-area">
                <textarea id="file-editor-textarea" spellcheck="false"></textarea>
            </div>
            <div id="editor-footer">
                <button class="editor-btn editor-btn-cancel" onclick="closeEditor()">Anuluj</button>
                <button class="editor-btn editor-btn-save" onclick="saveFileContent()">Zapisz zmiany</button>
            </div>
        </div>
    </div>

    <div id="context-menu" class="hidden">
        <div class="context-menu-item" id="new-folder-btn">Nowy folder</div>
    </div>

<script>
function copyToClipboard(elementId) {
    const copyText = document.getElementById(elementId);
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    navigator.clipboard.writeText(copyText.value).then(() => {
        const btn = copyText.nextElementSibling;
        const originalText = btn.textContent;
        btn.textContent = "Skopiowano!";
        setTimeout(() => btn.textContent = originalText, 1500);
    });
}

let currentEditingFile = "";
let sessionToken = null; 
let currentPreviewPath = null; // Zmienna do przechowywania ≈õcie≈ºki aktualnie otwartego pliku

document.addEventListener('DOMContentLoaded', () => {

    const BACKEND_URL = "https://eosforus-box.hf.space";
    const TEXT_FILE_EXTENSIONS = ['txt', 'md', 'json', 'js', 'py', 'css', 'html', 'log', 'xml', 'yaml', 'yml', 'ini', 'sh'];
    const IMAGE_FILE_EXTENSIONS = ['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg'];
    const ARCHIVE_FILE_EXTENSIONS = ['zip', 'rar', '7z', 'tar'];
    const VIDEO_FILE_EXTENSIONS = ['mp4', 'webm', 'ogv', 'mov'];
    const AUDIO_FILE_EXTENSIONS = ['mp3', 'wav', 'ogg'];
    const ODT_FILE_EXTENSIONS = ['odt'];
    
    let currentPath = '';
    let allFilesCache = [];
    let currentUploadXHR = null;
    let currentPlaylist = [];
    let currentTrackIndex = -1;
    let fileToShare = null;

    const dom = {
        loginScreen: document.getElementById('login-screen'),
        appContainer: document.getElementById('app-container'),
        accessCodeInput: document.getElementById('access-code'),
        loginButton: document.getElementById('login-button'),
        errorMessage: document.getElementById('error-message'),
        uploadArea: document.getElementById('upload-area'),
        uploadFileBtn: document.getElementById('upload-file-btn'),
        uploadFolderBtn: document.getElementById('upload-folder-btn'),
        statusMessage: document.getElementById('status-message'),
        progressBarContainer: document.getElementById('progress-bar-container'),
        progressBar: document.getElementById('progress-bar'),
        statusContainer: document.getElementById('status-container'),
        cancelUploadBtn: document.getElementById('cancel-upload-btn'),
        fileInput: document.getElementById('file-input'),
        folderInput: document.getElementById('folder-input'),
        fileListContainer: document.getElementById('file-list-container'),
        pathBar: document.getElementById('path-bar'),
        
        modalOverlay: document.getElementById('modal-overlay'),
        modalFilename: document.getElementById('modal-filename'),
        modalContentText: document.querySelector('#modal-content pre'),
        modalContentCode: document.querySelector('#modal-content pre code'),
        modalHtmlViewer: document.getElementById('modal-html-viewer'),
        modalImage: document.getElementById('modal-image'),
        modalPdfViewer: document.getElementById('modal-pdf-viewer'),
        modalVideoViewer: document.getElementById('modal-video-viewer'),
        modalAudioViewer: document.getElementById('modal-audio-viewer'),
        modalCloseBtn: document.getElementById('modal-close-btn'),
        modalConvertActions: document.getElementById('modal-convert-actions'), // Referencja do przycisk√≥w konwersji
        
        contextMenu: document.getElementById('context-menu'),
        newFolderBtn: document.getElementById('new-folder-btn'),
        playlistContainer: document.getElementById('modal-playlist-container'),
        
        shareModalOverlay: document.getElementById('share-modal-overlay'),
        shareModalCloseBtn: document.getElementById('share-modal-close-btn'),
        shareModalTitle: document.getElementById('share-modal-title'),
        shareExpiresValue: document.getElementById('share-expires-value'),
        shareExpiresUnit: document.getElementById('share-expires-unit'),
        generateShareLinkBtn: document.getElementById('generate-share-link-btn'),
        shareResults: document.getElementById('share-results'),
        shareResultLink: document.getElementById('share-result-link'),
        shareResultEmbed: document.getElementById('share-result-embed'),

        editorModalOverlay: document.getElementById('editor-modal-overlay'),
        editorFilename: document.getElementById('editor-filename'),
        editorTextarea: document.getElementById('file-editor-textarea')
    };

    function getAuthHeaders() { if (!sessionToken) throw new Error("Brak tokena sesji"); return { 'Authorization': `Bearer ${sessionToken}` }; }
    function forceDownload(path, filename) { dom.statusMessage.textContent = "Rozpoczynanie pobierania..."; const downloadUrl = `${BACKEND_URL}/download/${encodeURIComponent(path)}?token=${sessionToken}`; window.location.href = downloadUrl; setTimeout(() => dom.statusMessage.textContent = "", 2000); }
    async function loadAndSetImagePreview(element, path) { try { const fileUrl = `${BACKEND_URL}/download/${encodeURIComponent(path)}?token=${sessionToken}&preview=true`; const response = await fetch(fileUrl); if (!response.ok) return; const blob = await response.blob(); const blobUrl = URL.createObjectURL(blob); if (element.tagName === 'IMG') { element.src = blobUrl; } else { element.style.backgroundImage = `url(${blobUrl})`; } } catch (error) { console.error("B≈ÇƒÖd ≈Çadowania podglƒÖdu:", error); } }
    
    // NOWA FUNKCJA POBIERANIA JAKO
    window.downloadAs = function(format) {
        if (!currentPreviewPath) return alert("B≈ÇƒÖd: Nie wybrano pliku.");
        const downloadUrl = `${BACKEND_URL}/convert-download?path=${encodeURIComponent(currentPreviewPath)}&format=${format}&token=${sessionToken}`;
        
        // Tworzenie tymczasowego linku do pobrania
        const a = document.createElement('a');
        a.href = downloadUrl;
        a.download = ''; 
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    };

    window.openEditor = async function(filePath) {
        if (!sessionToken) return alert("Musisz byƒá zalogowany!");
        dom.editorFilename.innerText = "≈Åadowanie: " + filePath;
        dom.editorTextarea.value = "Pobieranie tre≈õci...";
        dom.editorTextarea.disabled = true;
        dom.editorModalOverlay.classList.remove('hidden');

        try {
            const response = await fetch(`${BACKEND_URL}/get-content`, {
                method: "POST",
                headers: { "Content-Type": "application/json", ...getAuthHeaders() },
                body: JSON.stringify({ path: filePath })
            });
            const data = await response.json();

            if (!response.ok || data.status === 'error') {
                alert(data.detail || "B≈ÇƒÖd podczas otwierania pliku.");
                window.closeEditor();
                return;
            }

            currentEditingFile = filePath;
            dom.editorFilename.innerText = "Edycja: " + filePath;
            dom.editorTextarea.value = data.content;
            dom.editorTextarea.disabled = false;
        } catch (error) {
            console.error("B≈ÇƒÖd:", error);
            alert("WystƒÖpi≈Ç b≈ÇƒÖd po≈ÇƒÖczenia.");
            window.closeEditor();
        }
    };

    window.saveFileContent = async function() {
        if (!currentEditingFile) return;
        const content = dom.editorTextarea.value;
        if (!confirm("Czy na pewno chcesz nadpisaƒá ten plik?")) return;

        const originalBtnText = document.querySelector('.editor-btn-save').innerText;
        document.querySelector('.editor-btn-save').innerText = "Zapisywanie...";

        try {
            const response = await fetch(`${BACKEND_URL}/save-content`, {
                method: "POST",
                headers: { "Content-Type": "application/json", ...getAuthHeaders() },
                body: JSON.stringify({ path: currentEditingFile, content: content })
            });

            if (response.ok) {
                alert("Plik zosta≈Ç zapisany pomy≈õlnie!");
                window.closeEditor();
                loadAllFilesFromServer(); 
            } else {
                const data = await response.json();
                alert("B≈ÇƒÖd zapisu: " + data.detail);
            }
        } catch (error) {
            console.error("B≈ÇƒÖd:", error);
            alert("B≈ÇƒÖd po≈ÇƒÖczenia podczas zapisywania.");
        } finally {
            document.querySelector('.editor-btn-save').innerText = originalBtnText;
        }
    };

    window.closeEditor = function() {
        dom.editorModalOverlay.classList.add('hidden');
        dom.editorTextarea.value = "";
        currentEditingFile = "";
    };

    async function showModal(filename, type, path) {
        // Zapisz ≈õcie≈ºkƒô do globalnej zmiennej dla konwertera
        currentPreviewPath = path;

        dom.playlistContainer.classList.add('hidden');
        dom.playlistContainer.innerHTML = '';
        currentPlaylist = []; currentTrackIndex = -1;

        dom.modalFilename.textContent = filename;
        
        dom.modalImage.style.display = 'none';
        dom.modalContentText.style.display = 'none';
        dom.modalHtmlViewer.style.display = 'none';
        dom.modalPdfViewer.style.display = 'none';
        dom.modalVideoViewer.style.display = 'none';
        dom.modalAudioViewer.style.display = 'none';
        
        // Ukryj przyciski konwersji domy≈õlnie
        dom.modalConvertActions.classList.add('hidden');

        dom.modalOverlay.classList.remove('hidden');
        
        const fileUrl = `${BACKEND_URL}/download/${encodeURIComponent(path)}`;

        if (type === 'odt') {
            // Poka≈º przyciski konwersji tylko dla ODT
            dom.modalConvertActions.classList.remove('hidden');
            
            dom.modalFilename.textContent = "≈Åadowanie dokumentu...";
            try {
                const response = await fetch(`${BACKEND_URL}/get-content`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", ...getAuthHeaders() },
                    body: JSON.stringify({ path: path })
                });
                const data = await response.json();
                
                if(data.status === 'error') throw new Error(data.detail);
                
                dom.modalFilename.textContent = filename;
                dom.modalHtmlViewer.style.display = 'block';
                dom.modalHtmlViewer.innerHTML = data.content;
            } catch (e) {
                alert("B≈ÇƒÖd podglƒÖdu: " + e.message);
                dom.modalOverlay.classList.add('hidden');
            }
        }
        else if (type === 'pdf' || type === 'video') {
            const previewUrl = `${fileUrl}?token=${sessionToken}&preview=true`;
            if (type === 'pdf') { dom.modalPdfViewer.style.display = 'block'; dom.modalPdfViewer.src = previewUrl; } 
            else { dom.modalVideoViewer.style.display = 'block'; dom.modalVideoViewer.src = previewUrl; dom.modalVideoViewer.play(); }
        } else if (type === 'audio') {
            buildAndPlayPlaylist(path);
            dom.modalAudioViewer.style.display = 'block';
        } else if (type === 'image') {
            dom.modalImage.style.display = 'block';
            dom.modalImage.src = '';
            loadAndSetImagePreview(dom.modalImage, path);
        } else { // text preview
            try {
                const response = await fetch(fileUrl, { headers: getAuthHeaders() });
                if (!response.ok) throw new Error('Nie uda≈Ço siƒô pobraƒá zawarto≈õci');
                dom.modalContentText.style.display = 'block';
                dom.modalContentCode.textContent = await response.text();
            } catch (error) { alert(error.message); dom.modalOverlay.classList.add('hidden'); }
        }
    }

    function openShareModal(path) {
        fileToShare = path;
        const filename = path.split('/').pop();
        dom.shareModalTitle.textContent = `Udostƒôpnij: ${filename}`;
        dom.shareResults.classList.add('hidden');
        dom.shareExpiresValue.value = 1;
        dom.shareExpiresUnit.value = 'days';
        dom.shareExpiresValue.disabled = false;
        dom.shareModalOverlay.classList.remove('hidden');
    }

    dom.shareExpiresUnit.addEventListener('change', (e) => {
        if (e.target.value === 'never') {
            dom.shareExpiresValue.disabled = true;
        } else {
            dom.shareExpiresValue.disabled = false;
        }
    });

    dom.generateShareLinkBtn.addEventListener('click', async () => {
        if (!fileToShare) return;
        const expiresValue = parseInt(dom.shareExpiresValue.value);
        const expiresUnit = dom.shareExpiresUnit.value;
        dom.generateShareLinkBtn.textContent = "Generowanie...";
        dom.generateShareLinkBtn.disabled = true;
        try {
            const response = await fetch(`${BACKEND_URL}/share`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                body: JSON.stringify({ path: fileToShare, expires_value: expiresValue, expires_unit: expiresUnit })
            });
            if (!response.ok) throw new Error("B≈ÇƒÖd generowania linku.");
            const data = await response.json();
            dom.shareResultLink.value = data.link;
            dom.shareResultEmbed.value = data.embed_code;
            dom.shareResults.classList.remove('hidden');
        } catch (error) {
            alert(error.message);
        } finally {
            dom.generateShareLinkBtn.textContent = "Generuj Link";
            dom.generateShareLinkBtn.disabled = false;
        }
    });

    dom.shareModalCloseBtn.addEventListener('click', () => dom.shareModalOverlay.classList.add('hidden'));
    dom.shareModalOverlay.addEventListener('click', (e) => { if (e.target === dom.shareModalOverlay) dom.shareModalOverlay.classList.add('hidden'); });

    function buildAndPlayPlaylist(currentTrackPath) {
        const folderPath = currentTrackPath.includes('/') ? currentTrackPath.substring(0, currentTrackPath.lastIndexOf('/')) : '';
        const pathPrefix = folderPath ? folderPath + '/' : '';
        currentPlaylist = allFilesCache.filter(p => { const fileExt = p.split('.').pop().toLowerCase(); return p.startsWith(pathPrefix) && !p.substring(pathPrefix.length).includes('/') && AUDIO_FILE_EXTENSIONS.includes(fileExt); }).sort();
        renderPlaylist();
        const startIndex = currentPlaylist.indexOf(currentTrackPath);
        playTrackFromPlaylist(startIndex !== -1 ? startIndex : 0);
    }
    
    function renderPlaylist() {
        dom.playlistContainer.innerHTML = '';
        if (currentPlaylist.length > 1) {
            dom.playlistContainer.classList.remove('hidden');
            currentPlaylist.forEach((trackPath, index) => {
                const trackName = trackPath.split('/').pop();
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.dataset.index = index;
                item.onclick = () => playTrackFromPlaylist(index);
                const nameSpan = document.createElement('span');
                nameSpan.className = 'playlist-item-name';
                nameSpan.textContent = trackName;
                const removeBtn = document.createElement('button');
                removeBtn.className = 'playlist-remove-btn';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = (e) => removeTrackFromPlaylist(e, index);
                item.appendChild(nameSpan);
                item.appendChild(removeBtn);
                dom.playlistContainer.appendChild(item);
            });
        } else {
            dom.playlistContainer.classList.add('hidden');
        }
    }

    function removeTrackFromPlaylist(event, indexToRemove) {
        event.stopPropagation();
        const wasPlaying = currentTrackIndex === indexToRemove;
        currentPlaylist.splice(indexToRemove, 1);
        if (currentPlaylist.length === 0) { dom.modalAudioViewer.pause(); dom.modalCloseBtn.click(); return; }
        if (indexToRemove < currentTrackIndex) { currentTrackIndex--; }
        renderPlaylist();
        if (wasPlaying) {
            const nextIndex = Math.min(indexToRemove, currentPlaylist.length - 1);
            playTrackFromPlaylist(nextIndex);
        } else {
            Array.from(dom.playlistContainer.children).forEach((item, i) => { item.classList.toggle('active', i === currentTrackIndex); });
        }
    }

    function playTrackFromPlaylist(index) {
        if (index < 0 || index >= currentPlaylist.length) return;
        currentTrackIndex = index;
        const trackPath = currentPlaylist[index];
        const trackName = trackPath.split('/').pop();
        dom.modalFilename.textContent = trackName;
        const fileUrl = `${BACKEND_URL}/download/${encodeURIComponent(trackPath)}?token=${sessionToken}&preview=true`;
        dom.modalAudioViewer.src = fileUrl;
        dom.modalAudioViewer.play();
        Array.from(dom.playlistContainer.children).forEach((item, i) => {
            item.classList.toggle('active', i === index);
        });
    }

    dom.modalAudioViewer.addEventListener('ended', () => {
        if (currentPlaylist.length > 0) {
            const nextIndex = (currentTrackIndex + 1) % currentPlaylist.length;
            playTrackFromPlaylist(nextIndex);
        }
    });
    
    function renderPathBar() {
        dom.pathBar.innerHTML = '';
        const rootSegment = document.createElement('span');
        rootSegment.className = 'path-segment';
        rootSegment.textContent = 'G≈Ç√≥wny';
        rootSegment.onclick = () => { currentPath = ''; renderFiles(); };
        dom.pathBar.appendChild(rootSegment);
        let pathAccumulator = '';
        currentPath.split('/').filter(Boolean).forEach(segment => {
            pathAccumulator += (pathAccumulator ? '/' : '') + segment;
            const currentSegmentPath = pathAccumulator;
            dom.pathBar.append(' / ');
            const pathSegment = document.createElement('span');
            pathSegment.className = 'path-segment';
            pathSegment.textContent = segment;
            pathSegment.onclick = () => { currentPath = currentSegmentPath; renderFiles(); };
            dom.pathBar.appendChild(pathSegment);
        });
    }
    function renderFiles() {
        dom.fileListContainer.innerHTML = "";
        renderPathBar();
        const pathPrefix = currentPath ? currentPath + '/' : '';
        const currentLevelItems = allFilesCache.map(p => p.startsWith(pathPrefix) ? p.substring(pathPrefix.length) : null).filter(p => p);
        const folders = new Set();
        const files = new Set();
        currentLevelItems.forEach(p => {
            if (p.includes('/')) { folders.add(p.split('/')[0]); } 
            else if (p !== '.gitkeep') { files.add(p); }
        });
        [...folders].sort().forEach(name => addItemToGrid({ name, type: 'folder' }));
        [...files].sort().forEach(name => addItemToGrid({ name, type: 'file' }));
    }

    function addItemToGrid({ name, type }) {
        const fullPath = currentPath ? `${currentPath}/${name}` : name;
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.dataset.name = name;
        fileItem.dataset.type = type;
        fileItem.dataset.path = fullPath;
        fileItem.setAttribute('draggable', 'true');
        const icon = document.createElement('div');
        icon.className = 'file-icon';
        
        let isTextFile = false;
        if (type === 'folder') { icon.classList.add('file-icon-folder'); } 
        else {
            const fileExt = name.split('.').pop().toLowerCase();
            if (IMAGE_FILE_EXTENSIONS.includes(fileExt)) { loadAndSetImagePreview(icon, fullPath); } 
            else if (fileExt === 'pdf') { icon.classList.add('file-icon-pdf'); }
            else if (ODT_FILE_EXTENSIONS.includes(fileExt)) { icon.classList.add('file-icon-odt'); }
            else if (TEXT_FILE_EXTENSIONS.includes(fileExt)) { icon.classList.add('file-icon-txt'); isTextFile = true; } 
            else if (ARCHIVE_FILE_EXTENSIONS.includes(fileExt)) { icon.classList.add('file-icon-zip'); } 
            else if (VIDEO_FILE_EXTENSIONS.includes(fileExt)) { icon.classList.add('file-icon-video'); } 
            else if (AUDIO_FILE_EXTENSIONS.includes(fileExt)) { icon.classList.add('file-icon-audio'); }
            else { icon.classList.add('file-icon-img'); }
        }
        
        const nameEl = document.createElement('span');
        nameEl.className = 'file-name';
        nameEl.textContent = name;
        fileItem.append(icon, nameEl);
        
        const actions = document.createElement('div');
        actions.className = 'file-actions';
        
        if (type === 'file') { 
            actions.innerHTML = `<button class="action-btn share-btn" title="Udostƒôpnij link">üîó</button>`;
            if (isTextFile) {
                actions.innerHTML += `<button class="action-btn edit-content-btn" title="Edytuj tre≈õƒá">üìù</button>`;
            }
            actions.innerHTML += `<button class="action-btn download-btn" title="Pobierz">‚¨áÔ∏è</button>`; 
        } else {
             actions.innerHTML = "";
        }
        
        actions.innerHTML += `<button class="action-btn rename-btn" title="Zmie≈Ñ nazwƒô">‚úèÔ∏è</button><button class="action-btn delete-btn" title="Usu≈Ñ">üóëÔ∏è</button>`;
        fileItem.appendChild(actions);
        dom.fileListContainer.appendChild(fileItem);
    }

    async function loadAllFilesFromServer() {
        dom.statusMessage.textContent = "≈Åadowanie listy plik√≥w...";
        try {
            const response = await fetch(`${BACKEND_URL}/files`, { headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' } });
            if (!response.ok) throw new Error("B≈ÇƒÖd autoryzacji lub serwera");
            const data = await response.json();
            allFilesCache = data.files || [];
            renderFiles();
            dom.statusMessage.textContent = "";
        } catch (error) {
            dom.fileListContainer.innerHTML = `<p>Nie uda≈Ço siƒô za≈Çadowaƒá plik√≥w. ${error.message}</p>`;
            dom.statusMessage.textContent = "B≈ÇƒÖd.";
        }
    }
    async function handleFiles(files) {
        dom.statusContainer.classList.remove('hidden');
        dom.progressBarContainer.classList.remove('hidden');
        for (const file of files) {
            const relativePath = file.webkitRelativePath ? file.webkitRelativePath.substring(0, file.webkitRelativePath.lastIndexOf('/')) : '';
            const finalPath = [currentPath, relativePath].filter(Boolean).join('/');
            try { await uploadFileWithProgress(file, finalPath); } catch (error) { break; }
        }
        dom.statusContainer.classList.add('hidden');
        dom.progressBarContainer.classList.add('hidden');
        dom.progressBar.style.width = '0%';
        dom.statusMessage.textContent = "Przesy≈Çanie uko≈Ñczone. Od≈õwie≈ºanie listy...";
        await loadAllFilesFromServer();
    }
    function uploadFileWithProgress(file, path) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            currentUploadXHR = xhr;
            const formData = new FormData();
            formData.append('file', file);
            formData.append('path', path);
            xhr.upload.addEventListener('progress', e => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    dom.progressBar.style.width = percentComplete + '%';
                    dom.statusMessage.textContent = `Przesy≈Çanie: ${file.name} (${percentComplete}%)`;
                }
            });
            xhr.addEventListener('load', () => { currentUploadXHR = null; if (xhr.status >= 200 && xhr.status < 300) { resolve(xhr.response); } else { dom.statusMessage.textContent = `B≈ÇƒÖd: ${xhr.status}`; reject(`B≈ÇƒÖd serwera: ${xhr.status}`); } });
            xhr.addEventListener('error', () => { currentUploadXHR = null; dom.statusMessage.textContent = 'B≈ÇƒÖd sieciowy.'; reject('B≈ÇƒÖd sieciowy podczas przesy≈Çania.'); });
            xhr.addEventListener('abort', () => { currentUploadXHR = null; dom.statusMessage.textContent = 'Przesy≈Çanie anulowane.'; reject('Przesy≈Çanie anulowane przez u≈ºytkownika.'); });
            xhr.open('POST', `${BACKEND_URL}/upload`, true);
            xhr.setRequestHeader('Authorization', `Bearer ${sessionToken}`);
            xhr.send(formData);
        });
    }
    async function createNewFolder() {
        const folderName = prompt("Wprowad≈∫ nazwƒô nowego folderu:");
        if (folderName && folderName.trim()) {
            const fullPath = currentPath ? `${currentPath}/${folderName.trim()}` : folderName.trim();
            try { await fetch(`${BACKEND_URL}/create-folder`, { method: 'POST', headers: { 'Content-Type': 'application/json', ...getAuthHeaders() }, body: JSON.stringify({ path: fullPath }) }); await loadAllFilesFromServer(); } catch (error) { alert(error.message); }
        }
    }

    dom.cancelUploadBtn.addEventListener('click', () => { if (currentUploadXHR) { currentUploadXHR.abort(); } });
    dom.loginButton.addEventListener('click', async () => { try { const response = await fetch(`${BACKEND_URL}/login`, { method: "POST", headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ code: dom.accessCodeInput.value }) }); if (!response.ok) throw new Error("Nieprawid≈Çowy kod"); const data = await response.json(); sessionToken = data.access_token; dom.loginScreen.classList.add("hidden"); dom.appContainer.classList.remove("hidden"); loadAllFilesFromServer(); } catch (error) { dom.errorMessage.classList.remove("hidden"); } });
    dom.accessCodeInput.addEventListener('keyup', e => { if (e.key === 'Enter') dom.loginButton.click(); });
    dom.uploadFileBtn.addEventListener('click', () => dom.fileInput.click()); dom.uploadFolderBtn.addEventListener('click', () => dom.folderInput.click()); dom.fileInput.addEventListener('change', e => handleFiles(e.target.files)); dom.folderInput.addEventListener('change', e => handleFiles(e.target.files));
    dom.uploadArea.addEventListener('dragover', e => { e.preventDefault(); e.currentTarget.classList.add("drag-over"); }); dom.uploadArea.addEventListener('dragleave', e => { e.preventDefault(); e.currentTarget.classList.remove("drag-over"); }); dom.uploadArea.addEventListener('drop', e => { e.preventDefault(); e.currentTarget.classList.remove("drag-over"); handleFiles(e.dataTransfer.files); });
    dom.modalCloseBtn.addEventListener('click', () => { 
        dom.modalOverlay.classList.add('hidden'); 
        dom.modalImage.src = ''; 
        dom.modalPdfViewer.src = 'about:blank'; 
        dom.modalVideoViewer.pause(); 
        dom.modalVideoViewer.src = ''; 
        dom.modalAudioViewer.pause(); 
        dom.modalAudioViewer.src = ''; 
        dom.modalHtmlViewer.innerHTML = '';
        currentPreviewPath = null;
    });
    dom.modalOverlay.addEventListener('click', (e) => { if (e.target === dom.modalOverlay) dom.modalCloseBtn.click(); });
    dom.newFolderBtn.addEventListener('click', createNewFolder);
    dom.appContainer.addEventListener('contextmenu', e => { if (e.target.closest('#file-list-container')) { e.preventDefault(); dom.contextMenu.style.top = `${e.clientY}px`; dom.contextMenu.style.left = `${e.clientX}px`; dom.contextMenu.classList.remove('hidden'); } });
    document.addEventListener('click', (e) => { if (!e.target.closest('#context-menu')) { dom.contextMenu.classList.add('hidden'); } });
    dom.fileListContainer.addEventListener('dragstart', (e) => { const fileItem = e.target.closest('.file-item'); if (fileItem) { e.dataTransfer.setData('text/plain', fileItem.dataset.path); e.dataTransfer.effectAllowed = 'copy'; } });
    dom.fileListContainer.addEventListener('dragover', (e) => { e.preventDefault(); const targetItem = e.target.closest('.file-item'); document.querySelectorAll('.file-item.drag-over-folder').forEach(item => item.classList.remove('drag-over-folder')); if (targetItem && targetItem.dataset.type === 'folder') { const sourcePath = e.dataTransfer.getData('text/plain'); if (targetItem.dataset.path !== sourcePath) { targetItem.classList.add('drag-over-folder'); } } });
    dom.fileListContainer.addEventListener('dragleave', (e) => { const targetItem = e.target.closest('.file-item'); if (targetItem) { targetItem.classList.remove('drag-over-folder'); } });
    dom.fileListContainer.addEventListener('drop', async (e) => { e.preventDefault(); const dropTarget = e.target.closest('.file-item'); document.querySelectorAll('.file-item.drag-over-folder').forEach(item => item.classList.remove('drag-over-folder')); const old_path = e.dataTransfer.getData('text/plain'); if (dropTarget && dropTarget.dataset.type === 'folder' && dropTarget.dataset.path !== old_path) { const itemName = old_path.split('/').pop(); const new_path = `${dropTarget.dataset.path}/${itemName}`; if (new_path.startsWith(old_path + '/')) { alert("Nie mo≈ºna skopiowaƒá folderu do jego w≈Çasnego wnƒôtrza."); return; } try { await fetch(`${BACKEND_URL}/copy`, { method: 'POST', headers: { 'Content-Type': 'application/json', ...getAuthHeaders() }, body: JSON.stringify({ old_path, new_path }) }); await loadAllFilesFromServer(); } catch (error) { alert("Nie uda≈Ço siƒô skopiowaƒá elementu."); } } });
    dom.fileListContainer.addEventListener('dragend', (e) => { document.querySelectorAll('.file-item.drag-over-folder').forEach(item => item.classList.remove('drag-over-folder')); });

    dom.fileListContainer.addEventListener('click', async (e) => {
        const target = e.target;
        const fileItem = target.closest('.file-item');
        if (!fileItem) return;
        const name = fileItem.dataset.name;
        const type = fileItem.dataset.type;
        const path = fileItem.dataset.path;

        if (target.matches('.share-btn')) { openShareModal(path); return; }
        
        if (target.matches('.edit-content-btn')) { window.openEditor(path); return; }

        if (target.matches('.download-btn')) { forceDownload(path, name); return; }
        if (type === 'folder' && !target.closest('.file-actions')) { currentPath = path; renderFiles(); return; }
        if (!target.closest('.file-actions')) {
            const fileExt = name.split('.').pop().toLowerCase();
            if (IMAGE_FILE_EXTENSIONS.includes(fileExt)) { showModal(name, 'image', path); } 
            else if (TEXT_FILE_EXTENSIONS.includes(fileExt)) { showModal(name, 'text', path); } 
            else if (fileExt === 'pdf') { showModal(name, 'pdf', path); }
            else if (ODT_FILE_EXTENSIONS.includes(fileExt)) { showModal(name, 'odt', path); }
            else if (VIDEO_FILE_EXTENSIONS.includes(fileExt)) { showModal(name, 'video', path); }
            else if (AUDIO_FILE_EXTENSIONS.includes(fileExt)) { showModal(name, 'audio', path); }
            return;
        }
        if (target.matches('.delete-btn')) { const isFolder = type === 'folder'; const confirmMsg = isFolder ? `Czy na pewno chcesz usunƒÖƒá folder "${name}" i CA≈ÅƒÑ JEGO ZAWARTO≈öƒÜ?` : `Czy na pewno chcesz usunƒÖƒá plik "${name}"?`; if (!confirm(confirmMsg)) return; try { await fetch(`${BACKEND_URL}/delete`, { method: 'POST', headers: { 'Content-Type': 'application/json', ...getAuthHeaders() }, body: JSON.stringify({ path }) }); await loadAllFilesFromServer(); } catch (error) { alert(`Nie uda≈Ço siƒô usunƒÖƒá.`); } }
        if (target.matches('.rename-btn')) { const newName = prompt("Wprowad≈∫ nowƒÖ nazwƒô:", name); if (newName && newName !== name) { const newPath = currentPath ? `${currentPath}/${newName}` : newName; try { await fetch(`${BACKEND_URL}/rename`, { method: 'POST', headers: { 'Content-Type': 'application/json', ...getAuthHeaders() }, body: JSON.stringify({ old_path: path, new_path: newPath }) }); await loadAllFilesFromServer(); } catch (error) { alert("Nie uda≈Ço siƒô zmieniƒá nazwy."); } } }
    });
});
</script>
</body>
</html>